# User Guide - Aligning atlas to a new brain stack

## Setup New Brain Metainformation

This guide in its current form assumes the computer being worked on has the necessary dependant software already installed and configured (CUDA, Python, ImageMagick, PyQt). 

---

All variables will use the following syntax: `$VARIABLE_NAME`. These must be replaced by there proper values e.g. `$REPO_DIR` should be replaced with the actual filepath to your repository directory as described below.

#### Initialize the virtual environment

##### Description

A configuration script is provided to create a [virtualenv](https://virtualenv.pypa.io/en/stable/) called **mousebrainatlas-virtualenv** and install necessary packages. The virtual environment must be started again every time you open a new terminal window.

First, you need to know the directory in which you installed this "MouseBrainAtlas_dev" repository. This is considered the `PROJECT_DIR`, or repository directory, of the project.

Next, you must have enough diskspace available, at least 1TB per brain, to keep all of the necessary files on your local machine. Create a folder to store all of the data generated by the pipeline, this will be called your `ROOT_DIR`.

#### Commands

- Open the file "`$PROJECT_DIR`/setup/config.sh" in your favorite text editor. Notice `PROJECT_DIR` and `ROOT_DIR` are set equal to certain filepaths at the beginning of the file. Change these filepaths as described in the following bullet points.
    - Set `PROJECT_DIR` to the directory in which this Github repo is located on your computer.
    - Set `ROOT_DIR` to a folder that will be the root of all data loaded and generated throughout the pipeline. Expect about 1TB of space to be taken up by every brain stack as it runs through the pipeline.

Open the terminal and run the following commands: 
- Change directories using the "`cd`" command into this repository's directory. If you are unfamiliar with the terminal, please reference [this site](https://www.digitalocean.com/community/tutorials/how-to-use-cd-pwd-and-ls-to-explore-the-file-system-on-a-linux-server) which will walk through some file navigation commands.
    - To check that you are in the correct directory, type `ls` which lists all files and folders in the current directory. You should see the following folders: 'doc', 'src', 'demo', and 'setuup' among others.
- Run the command `source setup/config.sh` inside of the terminal. 
    - The command prompt should now have `mousebrainatlas_virtualenv` in parentheses prepended on the left side of the input line, this indicates that everything has run successfully.

#### Running a new brain

Now we enter in the metadata for the new brain. You will need to know the name of the brain stack (or name it yourself), the cutting plane, the planar resolution of the images, the slice thickness, the stain used, and the alternating stain number two if applicable.

Run the following commands in the terminal window you have already opened:
- `cd demo`
    - Move into the "demo/" directory, which contains all of the necessary scripts.
- `python a_GUI_initial.py`
    - This GUI will function as the driver of the pipeline. It will walk you through how to setup a new brain by entering in the relevant metadata, automatically copy and rename the tiff/jp2 stack and the sorted_filenames into your `ROOT_DIR`, and run the pipeline in its entirety (minus the manual steps the user must run) 
    
    
## Running the scripts

The pipeline is organized as a set of python scripts that are called iteratively, between each set of python scripts will be a manual step the user is required to perform. These user-intervention steps are necessary checks for some automatic processes throughout the pipeline.

The python scripts are intended to be run through a terminal (on Mac or Linux) from the `demo/` folder of this project while in the virtual environment that was initialized as described in "Setup". Consult the __[document running through the full pipeline script by script](pipeline.md)__ to run every script in order as well as an in depth description of the user-intervention steps and should be followed to properly run through the pipeline.
